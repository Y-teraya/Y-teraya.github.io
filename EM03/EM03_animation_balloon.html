<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>風船と本の物理実験</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #87CEEB, #E0F6FF);
            font-family: Arial, sans-serif;
            overflow: hidden;
        }
        #container {
            width: 100%;
            height: 100vh;
            position: relative;
        }
        #controls {
            position: absolute;
            top: 10px;
            left: 5%;
            width: 90%;
            max-width: 400px;
            z-index: 100;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            box-sizing: border-box;
        }
        .control-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="range"] {
            width: 100%;
            margin-bottom: 5px;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
            font-size: 14px;
        }
        button:hover {
            background: #45a049;
        }
        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        #status {
            margin-top: 15px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 5px;
            font-weight: bold;
        }
        .warning {
            color: #ff6b6b;
        }
        .safe {
            color: #4CAF50;
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="controls">
            <div class="control-group">
                <label for="bookWeight">本の重さ: <span id="weightValue">100</span>g</label>
                <input type="range" id="bookWeight" min="50" max="300" value="100" step="10">
            </div>
            <div class="control-group">
                <button id="resetBtn">リセット</button>
                <button id="dropBtn">落とす</button>
            </div>
            <div id="status" class="safe">
                風船は安全です
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // グローバル変数
        let scene, camera, renderer, balloon, book, balloonString, bookPages = [];
        let balloonBurst = false;
        let animationId;
        let isPaused = false;
        let balloonScale = 1;
        let bookWeight = 100;
        let maxWeight = 250;
        
        // パーティクルシステム用
        let particles = [];
        
        // 物理パラメータ
        const balloonBaseY = -1.5; // 風船をさらに下に移動
        let balloonY = balloonBaseY;
        let bookY = 1; // 本の位置も下に
        let velocityY = 0;
        const gravity = -0.01;
        const bounce = 0.3;
        let bookDropped = false;
        let bookOnBalloon = false; // 本が風船の上にいるかどうか

        function init() {
            // シーンの設定
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87CEEB);

            // カメラの設定
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(-3, -0.5, 6);
            camera.lookAt(0, -0.5, 0);

            // レンダラーの設定
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            document.getElementById('container').appendChild(renderer.domElement);

            // ライトの設定
            const ambientLight = new THREE.AmbientLight(0x404040, 0.8);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
            directionalLight.position.set(5, 10, 5);
            directionalLight.castShadow = true;
            directionalLight.shadow.mapSize.width = 2048;
            directionalLight.shadow.mapSize.height = 2048;
            scene.add(directionalLight);

            // 床の作成
            const floorGeometry = new THREE.PlaneGeometry(20, 20);
            const floorMaterial = new THREE.MeshLambertMaterial({ color: 0x90EE90 });
            const floor = new THREE.Mesh(floorGeometry, floorMaterial);
            floor.rotation.x = -Math.PI / 2;
            floor.position.y = -4.5; // 床をもっと下に
            floor.receiveShadow = true;
            scene.add(floor);

            // 風船の作成
            createBalloon();
            
            // 本の作成
            createBook();

            // コントロールイベントの設定
            setupControls();

            // アニメーション開始
            animate();
        }

        function createBalloon() {
            // 風船のジオメトリ（楕円形）
            const balloonGeometry = new THREE.SphereGeometry(1, 32, 32);
            balloonGeometry.scale(1, 1.3, 1); // 縦に少し伸ばす
            
            const balloonMaterial = new THREE.MeshPhongMaterial({
                color: 0xff6b6b,
                transparent: true,
                opacity: 0.8,
                shininess: 100
            });
            
            balloon = new THREE.Mesh(balloonGeometry, balloonMaterial);
            balloon.position.set(0, balloonBaseY, 0);
            balloon.castShadow = true;
            balloon.receiveShadow = true;
            scene.add(balloon);

            // 風船の紐
            const stringGeometry = new THREE.CylinderGeometry(0.02, 0.02, 2, 8);
            const stringMaterial = new THREE.MeshBasicMaterial({ color: 0x333333 });
            balloonString = new THREE.Mesh(stringGeometry, stringMaterial);
            balloonString.position.set(0, -2.5, 0); // 紐の位置も下に調整
            scene.add(balloonString);
        }

        function createBook() {
            // 本のグループ
            book = new THREE.Group();
            
            // 初期ページ数で本を作成
            updateBookThickness();

            book.position.set(0, bookY, 0);
            book.castShadow = true;
            book.receiveShadow = true;
            scene.add(book);
        }

        function updateBookThickness() {
            // 既存の本の部品を全て削除
            while(book.children.length > 0) {
                book.remove(book.children[0]);
            }
            bookPages = [];

            // 重さに応じて厚さを計算
            const thickness = (bookWeight - 50) * 0.008 + 0.15;
            
            // 本の直方体（メイン部分）
            const bookGeometry = new THREE.BoxGeometry(1.4, thickness, 2);
            
            // 面ごとに異なる材質を設定
            const materials = [
                new THREE.MeshLambertMaterial({ color: 0x8B0000 }), // 右側面（表紙色）
                new THREE.MeshLambertMaterial({ color: 0xFFFFFF }), // 左側面（白）
                new THREE.MeshLambertMaterial({ color: 0x8B0000 }), // 上面（表紙色）
                new THREE.MeshLambertMaterial({ color: 0x8B0000 }), // 下面（表紙色）
                new THREE.MeshLambertMaterial({ color: 0xFFFFFF }), // 前面（白・見える側）
                new THREE.MeshLambertMaterial({ color: 0xFFFFFF })  // 奥面（白）
            ];
            
            const bookMesh = new THREE.Mesh(bookGeometry, materials);
            bookMesh.castShadow = true;
            bookMesh.receiveShadow = true;
            book.add(bookMesh);
            
            // 白い面に黒い線を追加（ページの境界線）
            const lineWidth = 0.01;
            
            // 前面の線（見える側）
            for (let i = 1; i < 10; i++) {
                const lineGeometry = new THREE.BoxGeometry(1.42, lineWidth, 0.01);
                const lineMaterial = new THREE.MeshBasicMaterial({ color: 0x333333 });
                const line = new THREE.Mesh(lineGeometry, lineMaterial);
                line.position.set(0, -thickness/2 + (thickness/10 * i), 1.01);
                book.add(line);
            }
            
            // 左側面の線
            for (let i = 1; i < 10; i++) {
                const lineGeometry = new THREE.BoxGeometry(0.01, lineWidth, 2.02);
                const lineMaterial = new THREE.MeshBasicMaterial({ color: 0x333333 });
                const line = new THREE.Mesh(lineGeometry, lineMaterial);
                line.position.set(-0.71, -thickness/2 + (thickness/10 * i), 0);
                book.add(line);
            }
            
            // 奥面の線
            for (let i = 1; i < 10; i++) {
                const lineGeometry = new THREE.BoxGeometry(1.42, lineWidth, 0.01);
                const lineMaterial = new THREE.MeshBasicMaterial({ color: 0x333333 });
                const line = new THREE.Mesh(lineGeometry, lineMaterial);
                line.position.set(0, -thickness/2 + (thickness/10 * i), -1.01);
                book.add(line);
            }
            
            // 本のタイトル部分（上面に）
            const titleGeometry = new THREE.BoxGeometry(1.0, 0.005, 0.3);
            const titleMaterial = new THREE.MeshLambertMaterial({ 
                color: 0xFFD700 // 金色
            });
            const title = new THREE.Mesh(titleGeometry, titleMaterial);
            title.position.set(0, thickness/2 + 0.005, 0.3);
            book.add(title);
        }

        function createBurstEffect() {
            // パーティクル効果
            for (let i = 0; i < 50; i++) {
                const particleGeometry = new THREE.SphereGeometry(0.05, 8, 8);
                const particleMaterial = new THREE.MeshBasicMaterial({
                    color: new THREE.Color().setHSL(Math.random(), 0.7, 0.5)
                });
                const particle = new THREE.Mesh(particleGeometry, particleMaterial);
                
                particle.position.copy(balloon.position);
                particle.velocity = new THREE.Vector3(
                    (Math.random() - 0.5) * 0.3,
                    Math.random() * 0.2,
                    (Math.random() - 0.5) * 0.3
                );
                
                particles.push(particle);
                scene.add(particle);
            }

            // 風船を削除
            scene.remove(balloon);
            // 紐も削除
            scene.remove(balloonString);
        }

        function updatePhysics() {
            if (isPaused) return;

            // 本が落とされていない場合は浮いている状態
            if (!bookDropped && !balloonBurst) {
                // 重さによる風船の変形（視覚的な予測）
                const weightRatio = bookWeight / maxWeight;
                balloonScale = 1 - (weightRatio * 0.3);
                balloon.scale.set(1, balloonScale, 1);
                
                // 風船の予想位置（まだ実際には支えていない）
                const predictedBalloonY = balloonBaseY - (weightRatio * 0.5);
                balloon.position.y = balloonBaseY; // 実際はまだ変化しない
                
                // 本は風船の上に浮いている（振動あり）
                book.position.y = bookY + Math.sin(Date.now() * 0.003) * 0.02; // 軽い浮遊感
                
                return;
            }

            // 本が風船の上で安定している場合は振動させない
            if (bookOnBalloon && !balloonBurst) {
                return; // 物理計算を停止
            }

            // 本が落とされた場合の物理計算
            if (bookDropped && !balloonBurst) {
                // 本が落下中
                velocityY += gravity * 2; // 少し早めに落下
                bookY += velocityY;
                
                // 風船との衝突判定
                const balloonTop = balloonY + balloonScale + 0.1;
                if (bookY <= balloonTop && velocityY < 0) {
                    // 風船に衝突！重さで割れるかどうか判定
                    if (bookWeight >= maxWeight) {
                        // 重すぎて割れる
                        burstBalloon();
                    } else {
                        // 風船が支える
                        bookY = balloonTop + 0.05;
                        velocityY = 0;
                        bookOnBalloon = true; // 本が風船の上で安定
                        
                        // 風船の変形
                        const weightRatio = bookWeight / maxWeight;
                        balloonScale = 1 - (weightRatio * 0.3);
                        balloon.scale.set(1, balloonScale, 1);
                        balloonY = balloonBaseY - (weightRatio * 0.5);
                        balloon.position.y = balloonY;
                        
                        // 成功のフィードバック
                        const status = document.getElementById('status');
                        status.textContent = `成功！風船が${bookWeight}gの本を支えています`;
                        status.className = 'safe';
                    }
                }
                
                book.position.y = bookY;
            }

            // 風船が割れた後の落下
            if (balloonBurst) {
                dropBook();
            }

            // パーティクルの更新
            updateParticles();
        }

        function burstBalloon() {
            balloonBurst = true;
            createBurstEffect();
            
            // 本を落下させる
            velocityY = 0;
            dropBook();
        }

        function dropBook() {
            if (!balloonBurst) return;
            
            velocityY += gravity;
            bookY += velocityY;
            
            // 床に着いたら跳ね返る
            if (bookY <= -4) { // 床の位置に合わせて調整
                bookY = -4;
                velocityY *= -bounce;
                if (Math.abs(velocityY) < 0.01) {
                    velocityY = 0;
                }
            }
            
            book.position.y = bookY;
        }

        function updateParticles() {
            particles.forEach((particle, index) => {
                particle.position.add(particle.velocity);
                particle.velocity.y -= 0.01; // 重力
                particle.material.opacity -= 0.02;
                
                if (particle.material.opacity <= 0) {
                    scene.remove(particle);
                    particles.splice(index, 1);
                }
            });
        }

        function setupControls() {
            const weightSlider = document.getElementById('bookWeight');
            const weightValue = document.getElementById('weightValue');
            const resetBtn = document.getElementById('resetBtn');
            const dropBtn = document.getElementById('dropBtn');
            const status = document.getElementById('status');

            weightSlider.addEventListener('input', (e) => {
                bookWeight = parseInt(e.target.value);
                weightValue.textContent = bookWeight;
                
                if (!balloonBurst) {
                    updateBookThickness();
                }
                
                // ステータス更新
                if (bookWeight >= maxWeight) {
                    status.textContent = `${bookWeight}g - 落とすと風船が割れます！`;
                    status.className = 'warning';
                } else if (bookWeight >= maxWeight * 0.8) {
                    status.textContent = `${bookWeight}g - 風船は支えられるかも？`;
                    status.className = 'warning';
                } else {
                    status.textContent = `${bookWeight}g - 風船は安全に支えられます`;
                    status.className = 'safe';
                }
            });

            resetBtn.addEventListener('click', () => {
                // リセット処理
                balloonBurst = false;
                bookDropped = false;
                bookOnBalloon = false; // 安定状態もリセット
                balloonScale = 1;
                balloonY = balloonBaseY;
                bookY = 1;
                velocityY = 0;
                isPaused = false;
                
                // パーティクルをクリア
                particles.forEach(particle => scene.remove(particle));
                particles = [];
                
                // 風船を再作成
                if (!balloon.parent) {
                    scene.add(balloon);
                }
                // 紐も再作成
                if (!balloonString.parent) {
                    scene.add(balloonString);
                }
                balloon.scale.set(1, 1, 1);
                balloon.position.set(0, balloonBaseY, 0);
                
                // 本をリセット
                book.position.set(0, bookY, 0);
                updateBookThickness();
                
                // UI更新
                dropBtn.disabled = false;
                status.textContent = '風船は安全です';
                status.className = 'safe';
            });

            dropBtn.addEventListener('click', () => {
                if (!bookDropped && !balloonBurst) {
                    // 本を落とす
                    bookDropped = true;
                    velocityY = 0; // 初期速度
                    dropBtn.disabled = true;
                    status.textContent = '本を落としています...';
                    status.className = 'warning';
                }
            });
        }

        function animate() {
            animationId = requestAnimationFrame(animate);
            
            updatePhysics();
            
            if (balloonBurst) {
                dropBook();
            }
            
            // 風船の微細な揺れ（割れていない場合）
            if (!balloonBurst) {
                balloon.rotation.z = Math.sin(Date.now() * 0.003) * 0.05;
            }
            
            renderer.render(scene, camera);
        }

        // ウィンドウリサイズ対応
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // 初期化
        init();
    </script>
</body>
</html>